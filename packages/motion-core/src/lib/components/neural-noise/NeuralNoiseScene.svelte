<script lang="ts">
	import { T, useTask, useThrelte } from "@threlte/core";
	import { Vector2, ShaderMaterial } from "three";

	interface Props {
		/**
		 * Speed of the noise animation.
		 * @default 1.0
		 */
		speed?: number;
	}

	let { speed = 1.0 }: Props = $props();

	let time = 0;
	let material = $state<ShaderMaterial>();
	const { size } = useThrelte();

	const vertexShader = `
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = vec4(position, 1.0);
    }
  `;

	const fragmentShader = `
  #ifdef GL_ES
    precision highp float;
  #endif
  uniform float uTime;
  uniform vec2 uResolution;
  varying vec2 vUv;

  vec4 buf[8];

  vec4 sigmoid(vec4 x) {
      return 1. / (1. + exp(-x));
  }

  vec4 cppn_fn(vec2 coordinate, float in0, float in1, float in2) {
      buf[6] = vec4(coordinate.x, coordinate.y, 0.394833 + in0, 0.36 + in1);
      buf[7] = vec4(0.14 + in2, sqrt(coordinate.x * coordinate.x + coordinate.y * coordinate.y), 0., 0.);

      buf[0] = mat4(vec4(6.540426, -3.612603, 0.759088, -1.136130), vec4(2.458271, 3.166036, 0.861174, 1.084861), vec4(-5.767454, -5.380386, 1.645391, -4.774287), vec4(5.528117, -5.542865, -0.909253, 3.251348)) * buf[6] + mat4(vec4(2.061491, -5.722911, 3.975766, 1.313651), vec4(-0.583046, 0.583926, -1.766196, -6.049330), vec4(0.000000, 0.000000, 0.000000, 0.000000), vec4(0.000000, 0.000000, 0.000000, -0.979990)) * buf[7] + vec4(1.253282, 1.124391, -1.796998, 3.539383);
      buf[1] = mat4(vec4(-3.979783, -6.061274, 1.429133, -4.909088), vec4(0.863146, 1.743291, 6.246279, 1.610654), vec4(2.494139, -3.501204, 1.645448, 4.961241), vec4(2.743589, 8.209261, 0.285961, -1.165539)) * buf[6] + mat4(vec4(5.587056, -12.081923, 0.472623, 15.870829), vec4(2.987511, 3.129433, -1.646950, -0.997152), vec4(0.000000, 0.000000, 0.000000, 0.000000), vec4(0.000000, 0.000000, 1.342039, 0.000000)) * buf[7] + vec4(-5.026926, -6.573602, -0.881249, 3.013238);
      buf[0] = sigmoid(buf[0]);
      buf[1] = sigmoid(buf[1]);

      buf[2] = mat4(vec4(-15.219568, 8.095543, -1.079261, -1.938198), vec4(-5.951362, 5.808604, 2.639378, 0.299649), vec4(-7.314523, 7.924815, 4.204860, 5.570548), vec4(5.389631, 8.979051, -1.914519, -0.494928)) * buf[6] + mat4(vec4(-11.967154, -11.608155, 6.991450, 10.966565), vec4(2.070100, -6.263192, -1.705036, -0.667190), vec4(0.523107, -0.459430, 0.000000, 0.000000), vec4(0.284982, 0.000000, 0.000000, 0.000000)) * buf[7] + vec4(-4.171640, -1.932802, -5.524558, -3.640119);
      buf[3] = mat4(vec4(2.365542, -13.738922, 2.498075, 3.233465), vec4(0.643007, 11.925601, 1.914105, 0.599957), vec4(-1.221195, 4.480722, 1.473398, 3.153624), vec4(5.003925, 13.000481, 3.758183, -4.556190)) * buf[6] + mat4(vec4(-0.394945, 7.675101, -3.142568, 5.357695), vec4(0.639362, 3.714393, -0.810838, -0.391749), vec4(-0.464944, 0.000000, 0.000000, 0.000000), vec4(-0.389630, 0.000000, 0.000000, 0.000000)) * buf[7] + vec4(-0.114427, -21.621881, 0.701516, 1.232972);
      buf[2] = sigmoid(buf[2]);
      buf[3] = sigmoid(buf[3]);

      buf[4] = mat4(vec4(5.214916, -7.183024, 1.469022, 2.659262), vec4(-5.601878, -25.359100, 5.252814, -0.655123), vec4(-10.577590, 24.426087, 21.102104, 37.546658), vec4(4.065813, -1.962523, 2.345880, -1.372816)) * buf[0] + mat4(vec4(-17.652600, -10.507558, 2.258741, 13.903974), vec4(7.151527, -502.754430, -12.642513, 1.491614), vec4(-10.983244, 21.518553, -9.701768, -0.763599), vec4(5.383626, 1.481954, -4.191162, -3.894631)) * buf[1] + mat4(vec4(12.664431, -15.129719, 2.151841, 1.795598), vec4(-30.483650, -1.834536, 1.454253, -1.111877), vec4(19.872723, -7.337935, -42.221286, -98.527090), vec4(7.216338, -2.263902, -2.272176, -36.142323)) * buf[2] + mat4(vec4(-16.298317, 3.547200, -0.431612, -9.444417), vec4(57.930017, -34.999026, 14.952836, -4.153475), vec4(-0.074703, -3.865648, -8.190795, 3.152397), vec4(-12.559385, -7.077619, 1.490437, -0.821154)) * buf[3] + vec4(-7.679140, 15.927437, 1.320773, -1.668611);
      buf[5] = mat4(vec4(-2.091698, -0.372762, -3.770383, -21.367174), vec4(-5.697247, -9.359080, 0.925290, 8.825610), vec4(11.100940, -22.348068, 13.625772, -18.693201), vec4(-0.342905, -3.990560, -2.462611, -0.450335)) * buf[0] + mat4(vec4(6.687929, -4.366184, -6.303765, -3.868115), vec4(1.546285, 6.548891, 0.998681, -0.083997), vec4(5.279798, -2.218040, 3.712769, -0.298296), vec4(-5.797390, 10.134961, -2.544084, -5.965605)) * buf[1] + mat4(vec4(-2.513259, -5.240878, -0.942249, -0.162853), vec4(0.203108, 0.537381, 5.827728, -1.302477), vec4(-1.326992, 2.011129, -6.243599, -3.728635), vec4(-13.562562, 9.115861, -0.917375, -3.623510)) * buf[2] + mat4(vec4(-8.645013, 6.554667, -6.261104, -5.593337), vec4(-0.577831, -1.077275, 37.875883, 5.736769), vec4(13.370495, 3.714665, 7.145225, -4.595878), vec4(2.719207, 3.602191, -5.682993, -2.365346)) * buf[3] + vec4(-5.900081, -3.887117, 0.552824, 8.595030);
      buf[4] = sigmoid(buf[4]);
      buf[5] = sigmoid(buf[5]);

      buf[6] = mat4(vec4(-1.611020, 2.387368, 1.467523, 0.209175), vec4(-28.793737, -7.139095, 0.567920, 4.656581), vec4(-10.948610, 39.662380, 0.743185, -10.095605), vec4(-1.494739, -1.548395, 0.730132, 2.168768)) * buf[0] + mat4(vec4(3.254775, 21.489103, -2.064689, -3.310059), vec4(-3.731663, -3.379216, -7.223193, -0.236858), vec4(13.334908, 0.791601, 6.748804, 4.633943), vec4(-5.918355, -17.471011, -5.732809, -1.645197)) * buf[1] + mat4(vec4(0.181934, -7.536463, -7.213122, -4.152557), vec4(-3.522382, -0.123593, -1.281234, 1.253653), vec4(9.745018, -22.853785, 2.062431, 0.099892), vec4(-4.319631, -17.730087, 1.787673, 5.302670)) * buf[2] + mat4(vec4(-6.545563, -15.790176, -7.403832, -5.832917), vec4(-43.591583, 28.551912, -16.001610, 18.847280), vec4(3.016699, 7.739835, 1.979384, 8.657522), vec4(-5.023757, -4.450633, -4.476800, -5.501044)) * buf[3] + mat4(vec4(1.698556, -67.435978, 6.897715, 1.900483), vec4(1.868035, 3.698088, 2.523111, 3.338005), vec4(11.158006, 1.762130, 3.292240, 8.073157), vec4(-4.256034, -306.180312, 8.581904, -18.178676)) * buf[4] + mat4(vec4(1.437698, -4.832095, 3.853480, -6.348217), vec4(1.354331, -1.264004, 9.932754, 3.113412), vec4(-5.294902, -0.949709, 0.128142, 3.326965), vec4(29.735424, -4.918278, 6.104408, 4.350323)) * buf[5] + vec4(7.445287, 12.161633, -3.770339, -4.775214);
      buf[7] = mat4(vec4(-8.265602, -4.702702, 5.098234, 0.606081), vec4(7.655864, -17.159490, 16.519390, -8.884479), vec4(-4.036479, -2.394687, -3.608247, -1.986653), vec4(-2.216774, -1.813565, -5.975987, 4.884645)) * buf[0] + mat4(vec4(5.393409, 3.507655, -2.819113, -2.702897), vec4(-6.749723, -0.278449, 1.495870, -5.051714), vec4(13.122226, 16.734630, -2.939748, -4.101023), vec4(-15.382187, -5.030483, -6.259933, 1.546973)) * buf[1] + mat4(vec4(5.272034, -0.940116, -5.171144, 4.755022), vec4(5.474831, 5.508097, 1.742591, -2.596731), vec4(3.100543, 0.163426, -104.563410, 16.949184), vec4(-5.540225, -2.392001, 3.835010, -1.936425)) * buf[2] + mat4(vec4(-6.321256, 1.794612, -13.604192, -3.806052), vec4(6.658346, 31.911177, 25.164474, 92.172378), vec4(12.297573, 4.150304, -0.731440, 6.768467), vec4(-5.563958, 4.034772, 5.827125, 0.565392)) * buf[3] + mat4(vec4(3.499244, -196.268100, -9.777457, 2.814263), vec4(3.480650, -3.184635, 5.443009, 5.180422), vec4(-2.858783, 15.585794, 1.286396, 2.025228), vec4(-71.252710, -62.441242, -9.509550, 0.506703)) * buf[4] + mat4(vec4(-12.229053, -10.800056, -7.347415, 4.390294), vec4(10.782412, 5.633738, 0.281580, -4.734872), vec4(-13.422884, -7.039391, 5.862442, 6.936266), vec4(-0.016766, 8.918980, 2.978114, 5.150952)) * buf[5] + vec4(2.241527, -6.705987, -0.988610, -3.351508);
      buf[6] = sigmoid(buf[6]);
      buf[7] = sigmoid(buf[7]);

      buf[0] = mat4(vec4(1.679426, 1.381747, 2.962545, 0.000000), vec4(-1.883441, -1.480694, -3.592452, 0.276962), vec4(-1.750944, -1.091806, -2.313352, 0.000000), vec4(0.266223, 1.434674, 0.441785, 0.000000)) * buf[0] + mat4(vec4(-0.629910, -1.612272, -0.770600, 0.000000), vec4(0.178290, 0.183002, 1.512083, 0.000000), vec4(-2.965440, -2.581994, -4.900105, 0.000000), vec4(0.855587, 1.186808, 2.517632, 0.000000)) * buf[1] + mat4(vec4(-1.258437, -1.055216, -2.168840, -0.780865), vec4(-0.720022, -0.526660, -1.438251, 0.000000), vec4(0.153453, 0.151961, 0.272854, -0.783078), vec4(1.587162, 0.886194, 0.363603, 0.000000)) * buf[2] + mat4(vec4(-1.559180, -0.711704, -4.351660, 0.012176), vec4(-22.641187, -18.831468, -41.954372, 0.000000), vec4(0.637920, 0.547065, 2.189343, -1.299702), vec4(-1.548989, -1.307593, -1.193073, 0.000000)) * buf[3] + mat4(vec4(-0.492521, 0.552633, -1.561702, 1.183937), vec4(0.956093, 0.221101, 1.640221, 1.199880), vec4(-1.056071, -2.664828, 0.863986, 0.000000), vec4(1.182598, 0.650587, 3.406331, 0.000000)) * buf[4] + mat4(vec4(0.354467, 0.329379, -0.537564, 1.214906), vec4(0.918448, -0.481778, -1.061483, -1.274231), vec4(2.796453, 1.000196, 4.684665, 0.000000), vec4(0.130426, 1.112316, 1.408710, 0.000000)) * buf[5] + mat4(vec4(-0.834081, -1.403319, -4.104067, 0.000000), vec4(3.166436, 2.638297, 4.957615, 0.831465), vec4(-3.172471, -3.204905, -5.549295, 0.320019), vec4(-1.903405, -2.249092, -5.301307, 0.000000)) * buf[6] + mat4(vec4(1.520384, -1.100839, 4.315299, 0.785230), vec4(1.521056, 1.265135, 2.683903, 0.000000), vec4(2.978947, 2.379847, 5.234726, 0.000000), vec4(2.227042, 1.575676, 3.802864, 0.879809)) * buf[7] + vec4(-2.903960, -3.617148, 1.865247, 0.000000);
      buf[0] = sigmoid(buf[0]);

      return vec4(buf[0].xyz, 1.0);
  }

  void main() {
    vec2 uv = vUv * 2.0 - 1.0;
    uv.y *= -1.0;

    vec4 color = cppn_fn(uv, 0.1 * sin(0.3 * uTime), 0.1 * sin(0.69 * uTime), 0.1 * sin(0.44 * uTime));

    gl_FragColor = vec4(color.rgb, 1.0);
  }
  `;

	useTask((delta) => {
		time += delta * speed;
		if (material) {
			material.uniforms.uTime.value = time;
			material.uniforms.uResolution.value.set($size.width, $size.height);
		}
	});
</script>

<T.Mesh>
	<T.PlaneGeometry args={[2, 2]} />
	<T.ShaderMaterial
		bind:ref={material}
		{vertexShader}
		{fragmentShader}
		transparent
		uniforms={{
			uTime: { value: 0 },
			uResolution: { value: new Vector2(1, 1) },
		}}
	/>
</T.Mesh>
